# Dynamic ServiceNow MCP Architecture

## Overview

The ServiceNow MCP Server v2.0 introduces a revolutionary **metadata-driven, dynamic tool generation system** that automatically creates MCP tools based on ServiceNow table definitions. This approach eliminates the need for manual tool creation and provides a scalable, maintainable solution.

## Key Features

### ðŸš€ **Dynamic Tool Generation**
- Tools are generated automatically from table metadata
- Consistent CRUD operations across all ServiceNow tables
- Zero-code tool addition for new tables
- Schema-driven validation

### ðŸ“Š **Metadata-Driven Configuration**
- Table definitions stored in JSON configuration
- Prompts defined in Markdown files
- Auto-discovery of ServiceNow table schemas
- Field-level metadata integration

### ðŸ”§ **Modular Architecture**
```
src/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ table-definitions.json    # Table metadata and configurations
â”‚   â””â”€â”€ prompts.md               # AI prompts for analysis
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ dynamic-tool-generator.js # Core tool generation engine
â”‚   â”œâ”€â”€ utility-tools.js         # Common utility operations
â”‚   â””â”€â”€ metadata-discovery.js    # ServiceNow schema discovery
â”œâ”€â”€ mcp-server-v2.js            # New modular server factory
â””â”€â”€ server.js                   # Express server (updated)
```

## How It Works

### 1. **Table Definition Schema**

Each ServiceNow table is defined with metadata:

```json
{
  "incident": {
    "label": "Incident",
    "table": "incident",
    "key_field": "number",
    "display_field": "short_description",
    "required_fields": ["short_description"],
    "common_fields": ["state", "priority", "urgency"],
    "operations": ["create", "read", "update", "list", "search"]
  }
}
```

### 2. **Automatic Tool Generation**

For each table, the system generates:
- `servicenow-create-{table}` - Create new records
- `servicenow-get-{table}` - Get record by sys_id
- `servicenow-update-{table}` - Update existing records
- `servicenow-list-{table}s` - List/query records
- `servicenow-search-{table}s` - Full-text search
- `servicenow-get-{table}-by-number` - Get by number field (if exists)

### 3. **Schema Validation**

Zod schemas are automatically generated based on:
- Required fields (marked as required in Zod)
- Common fields (optional in Zod)
- Field types and constraints
- Reference field relationships

### 4. **Metadata Discovery**

The system can automatically discover:
- Available tables in ServiceNow instance
- Field definitions and constraints
- Choice list values
- Table relationships
- Access permissions

## Benefits vs. Static Implementation

| Feature | Static (v1) | Dynamic (v2) |
|---------|-------------|--------------|
| **Tool Count** | 25+ manual tools | 40+ auto-generated tools |
| **Code Maintenance** | High - manual updates | Low - config-driven |
| **New Table Support** | Requires code changes | Add to JSON config |
| **Consistency** | Manual validation | Automatic consistency |
| **ServiceNow Updates** | Manual schema sync | Auto-discovery |
| **Custom Fields** | Not supported | Fully supported |
| **Testing** | Individual tool tests | Generic test patterns |

## Usage Examples

### Adding a New Table

Simply add to `table-definitions.json`:
```json
{
  "custom_table": {
    "label": "Custom Table",
    "table": "u_custom_table",
    "key_field": "number",
    "display_field": "name",
    "required_fields": ["name", "description"],
    "common_fields": ["state", "category"],
    "operations": ["create", "read", "update", "list", "search"]
  }
}
```

**Result**: 6 new MCP tools are automatically created!

### Discovering Tables Automatically

```javascript
const discovery = new MetadataDiscovery(client);
const definitions = await discovery.autoGenerateDefinitions();
// Automatically discovers all readable tables and generates definitions
```

### Custom Prompts

Add analysis prompts in `prompts.md`:
```markdown
## Custom Analysis Prompt
Analyze the provided data for:
- Business impact assessment
- Compliance requirements
- Risk factors
```

## Advanced Features

### 1. **Runtime Schema Discovery**
```javascript
// Get live schema from ServiceNow
const fields = await discovery.getTableFields('incident');
const choices = await discovery.getChoiceListValues('incident', 'state');
```

### 2. **Dynamic Resource Generation**
- `config://servicenow` - Server configuration
- `schema://tables/{table}` - Table schema information

### 3. **Extensible Prompt System**
- Markdown-based prompt definitions
- Context-aware analysis templates
- Domain-specific guidance

### 4. **Utility Tool Library**
- Generic record operations
- Assignment and routing
- Comment management
- Attachment handling

## Migration from v1

1. **Backup existing implementation**
2. **Update server.js import** to use `mcp-server-v2.js`
3. **Configure table definitions** in JSON
4. **Add custom prompts** to markdown file
5. **Test with MCP Inspector**

## Performance Benefits

- **Reduced Bundle Size**: Less code duplication
- **Faster Startup**: Cached tool generation
- **Memory Efficiency**: Shared validation schemas
- **Development Speed**: No manual tool coding
- **Maintenance**: Single source of truth

## Future Enhancements

- **Live Schema Sync**: Automatic ServiceNow schema updates
- **Custom Field Discovery**: Auto-detect custom fields
- **Advanced Relationships**: Cross-table operations
- **Workflow Integration**: Business rule automation
- **Performance Monitoring**: Tool usage analytics

## Testing Strategy

1. **Schema Validation Tests**: Ensure generated schemas work
2. **Tool Generation Tests**: Verify all expected tools exist
3. **ServiceNow Integration Tests**: Live instance validation
4. **Performance Tests**: Tool generation benchmarks
5. **Regression Tests**: Ensure compatibility

This dynamic architecture represents a paradigm shift from static tool definition to intelligent, metadata-driven tool generation, making the ServiceNow MCP server infinitely more scalable and maintainable.